<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>상품 검색</title>
</head>
<script>
    //onload function 으로 start 를 지정
    window.onload = start;
    var memberId;

    async function get(path, headers = {}){
        const url = path;
        const options = {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
                ...headers,
            },
        };
        const res = await fetch(url, options);
        const data = await res.json();
        if(res.ok){
            return data;
        } else {
            throw Error(data);
        }
    }

    function start(){
        get("/session", {})
            .then((data) => {
                //로그인상태인지 확인하는 매핑(로그인 시 nickname 반환, 아니면 "" 반환)
                const target = document.getElementById("nickname");
                target.innerHTML = data.nickname+" 님";
                memberId = data.memberId;
            })
            .catch((error) => {
                console.log(error);
            });
        //메인화면에서 검색으로 넘어온 값이 있는 지 확인, 이후에 검색 값을 보여줌
        var searchSelect;
        var searchValue;
        if(sessionStorage.getItem("searchValue") != ""){
            const searchText = document.getElementById("searchText");
            const selectButton = document.getElementById("select");

            searchSelect = sessionStorage.getItem("searchSelect");
            searchValue = sessionStorage.getItem("searchValue");

            searchText.value = searchValue;
            selectButton.value = searchSelect;
        } else {
            searchSelect = "";
            searchValue = "";
        }
        sendSearchItem(searchSelect, searchValue);
    }

    function searchItem(){
        const searchSelect = document.getElementById("select").value;
        const searchValue = document.getElementById("searchText").value;

        sendSearchBook(searchSelect, searchValue);
        return false;
    }

    function sendSearchItem(select, value){
        var path;
        if(select == "word"){
            path = "/api/item/search/word?word="+encodeURIComponent(value);
        } else if(select == "category"){
            path = "/api/item/search/category?author="+encodeURIComponent(value);
        } else if(select == "address"){
            path = "/api/item/search/address?address="+encodeURIComponent(value);
        } else {
            alert("기본검색");
            path = "/api/item/search";
        }
        get(path, {})
            .then((data) => {
                console.log(data.count);
                console.log(data.data[0].book);
                console.log(data.data[0].itemCondition);
                console.log(data.data[0].createDate);
                console.log(data.data[0].dealStatus);
                const container = document.getElementById("container");
                if(container.childElementCount != 0){
                    const temp = document.getElementById("searchBoard");
                    container.removeChild(temp);
                }
                const board = document.createElement("section");
                board.setAttribute("id", "searchBoard");
                container.appendChild(board);
                if(data.length == 0){
                    const itemForm = document.createElement("form");
                    const text = document.createElement("p");
                    text.innerHTML = "상품이 없습니다.";
                    itemForm.appendChild(text);
                    board.appendChild(itemForm);
                }
                for(var i = 0; i < data.count ; i++){
                    //책 정보
                    const itemForm = document.createElement("form");
                    itemForm.setAttribute("id", "bookForm"+i.toString());

                    const title = document.createElement("p");
                    title.setAttribute("id", "title"+i.toString());
                    title.innerHTML = "title: "+data.data[i].book.title;
                    itemForm.appendChild(title);

                    const publisher = document.createElement("p");
                    publisher.setAttribute("id", "publisher"+i.toString());
                    publisher.innerHTML = "publisher: "+data.data[i].book.publisher;
                    itemForm.appendChild(publisher);

                    const author = document.createElement("p");
                    author.setAttribute("id", "author"+i.toString());
                    author.innerHTML = "author: "+data.data[i].book.author;
                    itemForm.appendChild(author);

                    const category = document.createElement("p");
                    category.setAttribute("id", "category"+i.toString());
                    category.innerHTML = "category: "+data.data[i].book.category;
                    itemForm.appendChild(category);

                    //아이템 정보
                    const itemPrice = document.createElement("p");
                    itemPrice.setAttribute("id", "itemPrice"+i.toString());
                    itemPrice.innerHTML = "condition: "+data.data[i].itemPrice;
                    itemForm.appendChild(itemPrice);

                    const condition = document.createElement("p");
                    condition.setAttribute("id", "condition"+i.toString());
                    condition.innerHTML = "condition: "+data.data[i].itemCondition;
                    itemForm.appendChild(condition);

                    const date = document.createElement("p");
                    date.setAttribute("id", "data"+i.toString());
                    date.innerHTML = "date: "+data.data[i].createDate[0]+"년 "
                        +data.data[i].createDate[1]+"월 " +data.data[i].createDate[2]+"일 "
                        +data.data[i].createDate[3]+"시 " +data.data[i].createDate[4]+"분 "
                        +data.data[i].createDate[5]+"초 ";
                    itemForm.appendChild(date);

                    const status = document.createElement("p");
                    status.setAttribute("id", "status"+i.toString());
                    status.innerHTML = "status: "+data.data[i].dealStatus;
                    itemForm.appendChild(status);

                    const hit = document.createElement("p");
                    hit.setAttribute("id", "hit"+i.toString());
                    hit.innerHTML = "hit: "+data.data[i].hit;
                    itemForm.appendChild(status);

                    const line = document.createElement("hr");
                    itemForm.appendChild(line);

                    board.appendChild(itemForm);
                }
            })
            .catch((error) => {
                console.log(error);
            });
    }

</script>
<body>
    <h1>판매중인 책 검색</h1>
    <h3>검색 조건을 선택하고 검색하세요</h3>
    <select id="select">
        <option value="word">책 제목</option>
        <option value="category">카테고리</option>
        <option value="address">주소</option>
    </select>
    <input type="text" id="searchText" name="title" placeholder="검색 값 입력">
    <button type="submit" onclick="return searchItem()">검색</button>
    <hr>

    <div id="container">
    </div>
</body>
</html>